!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):"object"==typeof exports?exports.StateMan=e():t.StateMan=e()}(this,function(){return function(t){function e(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return t[n].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e,i){var n=i(1);n.Histery=i(2),n.util=i(3),n.State=i(4),t.exports=n},function(t,e,i){function n(t){return this instanceof n==!1?new n(t):(t=t||{},t.history&&(this.history=t.history),t.init&&t.init.call(this,t),this._states={},this._stashCallback=[],this.strict=t.strict,this.current=this.active=this,this.title=t.title,void this.on("end",function(){for(var t,e=this.current;e&&!(t=e.title);)e=e.parent;document.title="function"==typeof t?e.title():String(t||o)}))}var r=i(4),a=i(2),s=(i(5),i(3)),o=document.title,h=r.prototype.state;s.extend(s.emitable(n),{name:"",state:function(t){var e=this.active;return"string"==typeof t&&e&&(t=t.replace("~",e.name),e.parent&&(t=t.replace("^",e.parent.name||""))),h.apply(this,arguments)},start:function(t){return this.history||(this.history=new a(t)),this.history.isStart||(this.history.on("change",s.bind(this._afterPathChange,this)),this.history.start()),this},stop:function(){this.history.stop()},go:function(t,e,i){if(e=e||{},"string"==typeof t&&(t=this.state(t)),"function"==typeof e&&(i=e,e={}),e.encode!==!1){var n=t.encode(e.param);e.path=n,this.nav(n,{silent:!0,replace:e.replace})}return this._go(t,e,i),this},nav:function(t,e,i){return"function"==typeof e&&(i=e,e={}),e=e||{},e.path=t,this.history.nav(t,s.extend({silent:!0},e)),e.silent||this._afterPathChange(s.cleanPath(t),e,i),this},decode:function(t){var e=t.split("?"),i=this._findQuery(e[1]);t=e[0];var n=this._findState(this,t);return n&&s.extend(n.param,i),n},encode:function(t,e){var i=this.state(t);return i?i.encode(e):""},is:function(t,e,i){if(!t)return!1;var t=t.name||t,n=this.current,r=n.name,a=i?r===t:0===(r+".").indexOf(t+".");return a&&(!e||s.eql(e,this.param))},_afterPathChange:function(t,e,i){this.emit("history:change",t);var n=this.decode(t);return e=e||{},e.path=t,n?(e.param=n.param,void this._go(n,e,i)):this._notfound(e)},_notfound:function(t){var e=this.state("$notfound");return e&&this._go(e,t),this.emit("notfound",t)},_go:function(t,e,i){function n(t){r=!0,t!==!1&&u.emit("end"),u.pending=null,u._popStash()}var r;if("string"==typeof t&&(t=this.state(t)),!t)return s.log("destination is not defined");if(t.hasNext&&this.strict)return this._notfound({name:t.name});if(this.pending){var a=this.pending.current;this.pending.stop(),s.log("naving to ["+a.name+"] will be stoped, trying to ["+t.name+"] now")}e.param=e.param||{};var o=this.current,h=this._findBase(o,t),c=this.path,u=this;"function"==typeof i&&this._stashCallback.push(i),e.previous=o,e.current=t,o!==t&&(e.stop=function(){n(!1),u.nav(c?c:"/",{silent:!0})},u.emit("begin",e)),r!==!0&&(o!==t?this._walk(o,t,e,!0,function(i){return i===!1?(c&&this.nav(c,{silent:!0}),this.emit("abort",e)):(this.preOption=this.pending,this.pending=e,this.path=e.path,this.current=e.current,this.param=e.param,this.previous=e.previous,void this._walk(o,t,e,!1,function(t){return t===!1?(this.current=this.active,n(!1),this.emit("abort",e)):(this.active=e.current,n())}.bind(this)))}.bind(this)):(u._checkQueryAndParam(h,e),this.pending=null,n()))},_popStash:function(){console.log("stash");var t=this._stashCallback,e=t.length;if(this._stashCallback=[],e)for(var i=0;e>i;i++)t[i].call(this)},_walk:function(t,e,i,n,r){var a=this._findBase(t,e);i.basckward=!0,this._transit(t,a,i,n,function(t){return t===!1?r(t):(n||this._checkQueryAndParam(a,i),i.basckward=!1,void this._transit(a,e,i,n,r))}.bind(this))},_transit:function(t,e,i,n,r){if(t===e)return r();var a,s=t.name.length>e.name.length,o=s?"leave":"enter";n&&(o="can"+o.replace(/^\w/,function(t){return t.toUpperCase()}));var h=function(n){return a===e||n===!1?r(n):(a=a?this._computeNext(a,e):s?t:this._computeNext(t,e),s&&a===e||!a?r(n):void this._moveOn(a,o,i,h))}.bind(this);h()},_moveOn:function(t,e,i,n){function r(t){a||(o=!1,a=!0,n(t))}var a=!1,o=!1;i.async=function(){return o=!0,r},i.stop=function(){r(!1)},this.active=t;var h=t[e]?t[e](i):!0;return"enter"===e&&(t.visited=!0),s.isPromise(h)?this._wrapPromise(h,r):void(o||r(h))},_wrapPromise:function(t,e){return t.then(e,e.bind(this,!1))},_computeNext:function(t,e){var i=t.name,n=e.name,r=n.split("."),a=i.split("."),s=r.length,o=a.length;return""===i&&(o=0),""===n&&(s=0),s>o?a[o]=r[o]:a.pop(),this.state(a.join("."))},_findQuery:function(t){var e=t&&t.split("&"),i={};if(e)for(var n=e.length,i={},r=0;n>r;r++){var a=e[r].split("=");i[a[0]]=a[1]}return i},_findState:function(t,e){var i,n,r=t._states;if(t.hasNext)for(var a in r)if(r.hasOwnProperty(a)&&(i=this._findState(r[a],e)))return i;return n=t.regexp&&t.decode(e),n?(t.param=n,t):!1},_findBase:function(t,e){if(!t||!e||t==this||e==this)return this;for(var i,n=t,r=e;n&&r;){for(i=r;i;){if(n===i)return i;i=i.parent}n=n.parent}return this},_checkQueryAndParam:function(t,e){for(var i=t;i!==this;)i.update&&i.update(e),i=i.parent}},!0),t.exports=n},function(t,e,i){function n(t){t=t||{},this.location=t.location||r.location,this.html5=t.html5,this.mode=t.html5&&r.history?h:o,r.hash||(this.mode=s),t.mode&&(this.mode=t.mode),this.prefix="#"+(t.prefix||""),this.rPrefix=new RegExp(this.prefix+"(.*)$"),this.interval=t.interval||66,this.root=t.root||"/",this.rRoot=new RegExp("^"+this.root),this._fixInitState(),this.autolink=t.autolink!==!1,this.curPath=void 0}var r=i(5),a=i(3),s=3,o=1,h=2;a.extend(a.emitable(n),{start:function(){var t=this.getPath();if(this._checkPath=a.bind(this.checkPath,this),!this.isStart){switch(this.isStart=!0,this.mode===s&&this._fixHashProbelm(t),this.mode){case o:r.on(window,"hashchange",this._checkPath);break;case h:r.on(window,"popstate",this._checkPath);break;case s:this._checkLoop()}this.autolink&&this._autolink(),this.curPath=t,this.emit("change",t)}},stop:function(){r.off(window,"hashchange",this._checkPath),r.off(window,"popstate",this._checkPath),clearTimeout(this.tid),this.isStart=!1,this._checkPath=null},checkPath:function(){var t=this.getPath(),e=this.curPath;t===e&&this.iframe&&(t=this.getPath(this.iframe.location)),t!==e&&(this.iframe&&this.nav(t,{silent:!0}),this.curPath=t,this.emit("change",t))},getPath:function(t){var e,t=t||this.location;return this.mode!==h?(e=t.href.match(this.rPrefix),e&&e[1]?e[1]:""):a.cleanPath((t.pathname+t.search||"").replace(this.rRoot,"/"))},nav:function(t,e){var i=this.iframe;e=e||{},t=a.cleanPath(t),this.curPath!=t&&(this.curPath=t,this.mode!==h?(this._setHash(this.location,t,e.replace),i&&this.getPath(i.location)!==t&&(e.replace||i.document.open().close(),this._setHash(this.iframe.location,t,e.replace))):history[e.replace?"replaceState":"pushState"]({},e.title||"",a.cleanPath(this.root+t)),e.silent||this.emit("change",t))},_autolink:function(){if(this.mode===h){var t=(this.prefix,this);r.on(document.body,"click",function(e){var i=e.target||e.srcElement;if("a"===i.tagName.toLowerCase()){var n=(r.getHref(i)||"").match(t.rPrefix),a=n&&n[1]?n[1]:"";if(a)return e.preventDefault&&e.preventDefault(),t.nav(a),e.returnValue=!1}})}},_setHash:function(t,e,i){var n=t.href.replace(/(javascript:|#).*$/,"");i?t.replace(n+this.prefix+e):t.hash=this.prefix+e},_checkLoop:function(){var t=this;this.tid=setTimeout(function(){t._checkPath(),t._checkLoop()},this.interval)},_fixInitState:function(){var t,e,i=a.cleanPath(this.location.pathname);this.mode!==h&&this.html5?(e=i.replace(this.rRoot,""),e&&this.location.replace(this.root+this.prefix+e)):this.mode===h&&(t=this.location.hash.replace(this.prefix,""),t&&history.replaceState({},document.title,a.cleanPath(this.root+t)))},_fixHashProbelm:function(t){var e=document.createElement("iframe"),i=document.body;e.src="javascript:;",e.style.display="none",e.tabIndex=-1,e.title="",this.iframe=i.insertBefore(e,i.firstChild).contentWindow,this.iframe.document.open().close(),this.iframe.location.hash="#"+t}}),t.exports=n},function(t){function e(t){var e=0,n=[],r=0,a="";t=i.cleanPath(t);var s=t.replace(/\:([\w-]+)(?:\(([^\/]+?)\))?|(?:\(([^\/]+)\))|(\*{2,})|(\*(?!\*))/g,function(i,s,o,h,c,u,f){return f>e&&(a+=t.slice(e,f)),e=f+i.length,s?(a+="("+s+")",n.push(s),"("+(o||"[\\w-]+")+")"):(a+="("+r+")",n.push(r++),h?"("+h+")":c?"(.*)":u?"([^\\/]*)":void 0)});return e!==t.length&&(a+=t.slice(e)),{regexp:new RegExp("^"+s+"/?$"),keys:n,matches:a||t}}var i=t.exports={},n=[].slice,r={}.toString;i.extend=function(t,e,i){for(var n in e)(i||void 0===t[n])&&(t[n]=e[n]);return t},i.slice=function(t,e){return n.call(t,e)},i.typeOf=function(t){return null==t?String(t):r.call(t).slice(8,-1).toLowerCase()},i.eql=function(t,e){var n=i.typeOf(t),r=i.typeOf(e);if(n!==r)return!1;if("object"===n){var a=!0;for(var s in t)t[s]!==e[s]&&(a=!1);return a}return t===e},i.emitable=function(){var t={once:function(t,e){var i=function(){e.apply(this,arguments),this.off(t,i)};return this.on(t,i)},on:function(t,e){if("object"==typeof t)for(var i in t)this.on(i,t[i]);else{var n=this._handles||(this._handles={}),r=n[t]||(n[t]=[]);r.push(e)}return this},off:function(t,e){if(t&&this._handles||(this._handles={}),this._handles){var i,n=this._handles;if(i=n[t]){if(!e)return n[t]=[],this;for(var r=0,a=i.length;a>r;r++)if(e===i[r])return i.splice(r,1),this}return this}},emit:function(t){var e,n=i.slice(arguments,1),r=this._handles;if(!r||!(e=r[t]))return this;for(var a=0,s=e.length;s>a;a++)e[a].apply(this,n);return this}};return function(e){return e="function"==typeof e?e.prototype:e,i.extend(e,t)}}(),i.noop=function(){},i.bind=function(t,e){return function(){return t.apply(e,arguments)}};var a=/\/+/g,s=/\/$/;i.cleanPath=function(t){return("/"+t).replace(a,"/").replace(s,"")||"/"},i.log=function(t,e){"undefined"!=typeof console&&console[e||"log"](t)},i.isPromise=function(t){return!!t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof t.then},i.retTrue=function(){return!0},i.normalize=e},function(t,e,i){function n(t){this._states={},this._pending=!1,this.visited=!1,t&&this.config(t)}var r=i(3);n.rCache={},r.extend(r.emitable(n),{state:function(t,e){if("object"===r.typeOf(t)){for(var i in t)this.state(i,t[i]);return this}var a,s,o,h=this._states,i=0;"string"==typeof t&&(t=t.split("."));var c=t.length,a=this,u=[];do{if(o=t[i],s=h[o],u.push(o),!s){if(!e)return;s=h[o]=new n,r.extend(s,{parent:a,manager:a.manager||a,name:u.join("."),currentName:o}),a.hasNext=!0,s.configUrl()}a=s,h=s._states}while(++i<c);return e?(s.config(e),this):a},config:function(t){if(t){t=this._getConfig(t);for(var e in t){var i=t[e];switch(e){case"url":"string"==typeof i&&(this.url=i,this.configUrl());break;case"events":this.on(i);break;default:this[e]=i}}}},_getConfig:function(t){return"function"==typeof t?{enter:t}:t},configUrl:function(){for(var t="",e=this;e;){if(t=("string"==typeof e.url?e.url:e.currentName||"")+"/"+t,0===t.indexOf("^/")){t=t.slice(1);break}e=e.parent}this.pattern=r.cleanPath("/"+t);var i=this.pattern.split("?");this.pattern=i[0],r.extend(this,r.normalize(this.pattern),!0)},encode:function(t){var e=this;t=t||{};var i="%",n=e.matches.replace(/\(([\w-]+)\)/g,function(e,n){var r=t[n]||"";return i+=n+"%",r})+"?";for(var a in t)-1===i.indexOf("%"+a+"%")&&(n+=a+"="+t[a]+"&");return r.cleanPath(n.replace(/(?:\?|&)$/,""))},decode:function(t){var e=this.regexp.exec(t),i=this.keys;if(e){for(var n={},r=0,a=i.length;a>r;r++)n[i[r]]=e[r+1];return n}return!1},canEnter:r.retTrue,canLeave:r.retTrue,enter:r.retTrue,leave:r.retTrue,async:function(){throw new Error("please use option.async instead")}}),t.exports=n},function(t){{var e=window,i=document;t.exports={hash:"onhashchange"in e&&(!i.documentMode||i.documentMode>7),history:e.history&&"onpopstate"in e,location:e.location,getHref:function(t){return"href"in t?t.getAttribute("href",2):t.getAttribute("href")},on:"addEventListener"in e?function(t,e,i){return t.addEventListener(e,i)}:function(t,e,i){return t.attachEvent("on"+e,i)},off:"removeEventListener"in e?function(t,e,i){return t.removeEventListener(e,i)}:function(t,e,i){return t.detachEvent("on"+e,i)}}}}])});