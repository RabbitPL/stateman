<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>StateMan Test</title>
  <script src="../stateman.js"></script>
</head>
<body>

<ul>
  <li><a href="#/home">/home"</a></li>
  <li><a href="#/contact">/contact"</a></li>
  <li><a href="#/contact/list">/contact/list</a></li>
  <li><a href="#/contact/2">/contact/2</a></li>
  <li><a href="#/contact/2/option">/contact/2/option</a></li>
  <li><a href="#/contact/2/message">/contact/2/message</a></li>
  <li><a href="#/contact/2/data">/contact/2/data</a></li>
</ul>
  
<script>

  var config = {
    enter: function(){
      console.log("enter: " + this.name)
    },
    leave: function(){
      console.log("leave: " + this.name)
    }
  }

  function create(o){
    o = o || {};
    o.enter= o.enter || config.enter;
    o.leave = o.leave || config.leave;
    return o;
  }

  var delay = function(time){
    return new Promise(function(resolve){
      setTimeout( resolve, time)
    })
  }

  var confirmp = function(str){
    return new Promise(function (resolve, reject){
      if( confirm(str) ) return resolve()
      reject();
    })
  }

  var stateman = new StateMan();

  stateman
    .state("home", create({
      canEnter: function(){
        return confirmp('真的要进home么').then(function(){

          console.log('允许进入home', stateman.current)
          return true;

        })['catch'](function(){

          console.log('拒绝进入home', stateman.current)
          return false;

        })
      },
      canLeave: function(){
        return confirmp('真的要离开home么').then(function(){

          console.log('允许离开home', stateman.current)

        })['catch'](function(){

          console.log('拒绝离开home', stateman.current)
          return false;

        })

      }
    }))
    .state("contact", config)
    .state("contact.list", create({
      enter: function(option){
        this.delay = true;
        return delay(2000).then(function(){
          console.log('enter contact.list')
          this.delay = false
        }.bind(this))
        // console.log('enter contact.list')
      },
      canLeave: function(){
        if(this.delay){
          console.log('nav permit');
          return false;
        }
      }
    }) )
    .state("contact.detail", create({url: ":id(\\d+)"}))
    .state("contact.detail.option", config)
    .state("contact.detail.message", config)
    .state("contact.detail.data", config)
    .on("begin", function(option){
      if(option.current.name === "contact.detail"){
        option.stop();
        this.go("contact.detail.message", {
          param: {id: 3}
        })
      }
    })
    .start({})

</script>
</body>
</html>